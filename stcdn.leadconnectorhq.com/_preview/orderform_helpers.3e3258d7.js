import{m as f,C as z}from"./entry.7a41e7c5.js";import{a as N,P as G,O as K}from"./PaymentServices.973e92ac.js";import{A as X,P as R}from"./HLConst.f48fdde4.js";import{I as M,D as ii,F as $,w as W}from"./helpers.50520399.js";import{F as ei}from"./FunnelServices.5a3a982b.js";import{f as H}from"./funnel_event_helper.c4317f7c.js";import{s as p,e as Q,a as B,g as V,b as Z}from"./Attributions.a88a0b8c.js";import{v as ri,A as ai}from"./index.f268050a.js";const wi={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},vi=i=>{if(!i.length)return 0;let e=0;return i.map(t=>{e=(t.showNewPrice?t.newPrice:t.amount*t.qty)+e}),e},bi=(i,e,t)=>{let s=[];return{updatedProducts:i.map(a=>{if(a._id===t._id){if(e>a.max)return a.qty=a.qty,s.push(`A maximum of ${a.max} units of ${a.name} only can be purchased`),a;if(e>a.price.availableQuantity&&a.price.trackInventory&&!a.price.allowOutOfStockPurchases)return a.qty=a.qty,s.push(`Only ${a.price.availableQuantity} units of ${a.name} are in stock`),a;a.qty=e}return a}),errorMessages:s}},hi=i=>{var e,t,s;return((e=i==null?void 0:i.price)==null?void 0:e.availableQuantity)<=0&&((t=i==null?void 0:i.price)==null?void 0:t.trackInventory)&&!((s=i==null?void 0:i.price)!=null&&s.allowOutOfStockPurchases)},Pi=(i,e)=>e.find(t=>t._id===i.id),ti=async({contactId:i,domain:e,pageUrl:t,locationId:s,productPreviewList:d,isCouponApplied:a,couponCode:r,couponSessionId:n,store:g,subType:c,traceId:b,reCaptchaToken:m,isEcommercePurchase:h})=>{var I,y,o,P;try{const u=f("msgsndr_id").value,S=f("am_id").value,E=f("am_fingerprint").value,O=g.funnelName||"funnel";e||(e=window.location.hostname,t=window.location.pathname);const{funnelPageId:T,funnelId:C,stepId:A}=g,w={altId:s,altType:"location",contactId:i,source:{type:g.pageType===N.FUNNEL?N.FUNNEL:N.WEBSITE,subType:c,id:C,name:O,meta:{stepId:A,pageId:T,domain:e,pageUrl:t,affiliateManager:{id:S,fingerprint:E}}},products:d.map(v=>({id:h?v.selectedPrice._id:v._id,qty:v.qty||v.quantity})),fingerprint:u,trackingId:M(),traceId:b};a&&(w.couponCode=r,w.couponSessionId=n),m&&(w.captchaToken=m);const k=await G.createOrder(w);if(!((I=k.order)==null?void 0:I._id))throw new Error("Something went wrong while creating order. Please try again later.");return k}catch(u){return console.error(u),{error:!0,message:(o=(y=u==null?void 0:u.response)==null?void 0:y._data)==null?void 0:o.message,status:(P=u==null?void 0:u.response)==null?void 0:P.status}}},ni=async(i,e,t,s,d,a)=>{var U,q,x;const r=f("msgsndr_id").value,n=f("am_id").value,g=f("am_fingerprint").value,c=V(i.locationId),b=Z(i.locationId),m=B(),h=i.funnelName||"funnel";let{domain:I,page_url:y}=e.query;I||(I=window.location.hostname,y=window.location.pathname);const{funnelPageId:o,funnelId:P,stepId:u}=i,S={eventType:"optin",domainName:I,pageUrl:y,funnelId:P,pageId:o,stepId:u},{address:E,country:O,state:T,city:C,zipcode:A,fullName:w,phoneNumber:k,emailId:F,companyName:v}=t,D={addressLine1:E,country:O||s,state:T,city:C,zip:A};m.medium=ai.OrderForm,m.mediumId=S.stepId;const J={lead:!0,eventData:m,source:h,pageId:o,funnelId:P,sessionId:c,funnelEventData:S,sessionFingerprint:b||null},_={locationId:i.locationId,name:w,phone:k,email:(F==null?void 0:F.toLowerCase())||"",companyName:v,address:D,attribution:J,timezone:ii(),amId:String(n),amFingerprint:g,orderFormType:"one_step_form_submission",captchaToken:d};a.enableStickyContact&&(_.attribution.fingerprint=r,_.attribution.funnelEventData.fingerprint=r),a.enableForceCreate&&(_.attribution.forceCreate=!0),a.enableEmailValidation&&(_.attribution.session_d=Number(a.enableEmailValidation)||0);try{const l=await ei.createContact(_);if(!l)throw new Error("Something went wrong. Please try again later.");if(r!==l.fingerprint){i.fingerprint=r;const j=f("msgsndr_id",{path:"/",maxAge:31536e3});j.value=l.fingerprint}M();const Y=$(l);W("_ud",Y),z(()=>{H("track","SubmitApplication")});let L=l.sessionFingerprint;return m&&(p({sessionId:l.sessionId||null,locationId:i.locationId}),L&&Q(i.locationId,L)),l}catch(l){return console.error(l),{error:!0,message:(q=(U=l==null?void 0:l.response)==null?void 0:U._data)==null?void 0:q.message,status:(x=l==null?void 0:l.response)==null?void 0:x.status}}},_i=async(i,e,t,s,d,a,r,n,g,c,b,m,h,I)=>{var y;if((!r||!r.id)&&(r=await ni(i,e,t,s,d,a),d=void 0),r!=null&&r.error){let o={};return(r==null?void 0:r.status)===429?(o={error:!0,processingPayment:!1,showRecaptcha:!0},o):(o={error:!0,processingPayment:!1,cardErrorMsg:r.message||"We're sorry, but something went wrong. Please try again"},o)}if((r.id&&!n||!((y=n==null?void 0:n.order)!=null&&y._id))&&(n=await ti({contactId:r==null?void 0:r.id,domain:i.domain,pageUrl:i.pageUrl,locationId:i.locationId,productPreviewList:c,isCouponApplied:g,couponCode:m,couponSessionId:b,store:i,subType:I,traceId:r==null?void 0:r.traceId,reCaptchaToken:d,isEcommercePurchase:h}),d=void 0),n!=null&&n.error){let o={};return n.status===429?(o={error:!0,processingPayment:!1,showRecaptcha:!0,contactResponse:r},o):(o={error:!0,processingPayment:!1,contactResponse:r,cardErrorMsg:n.message||"We're sorry, but something went wrong. Please try again"},o)}return(n==null?void 0:n.success)===!1?{error:!0,cardErrorMsg:n==null?void 0:n.message,processingPayment:!1}:{contactResponse:r,orderResponse:n,reCaptchaToken:d}},si=(i,e,t,s)=>{var a;if(M()!=t.verifiedTrackingId){const r=f("tr",{path:"/",maxAge:900});r.value=t.verifiedTrackingId}if(s!==K.TWO_STEP_ORDER_FORM){if(i.fingerprint!==e){const n=f("msgsndr_id",{path:"/",maxAge:31536e3});n.value=i.fingerprint}const r=$(i);W("_ud",r)}if((a=i==null?void 0:i.attribution_source)!=null&&a.fbEventId){let r=i.attribution_source.fbEventId;z(()=>{H("track","OrderFormPurchase",r)})}else console.warn("Facebook event Id missing from attribution!")},Si=async(i,e,t,s,d)=>{let a=!1,r="";if(e.message&&!e.success)throw new Error(e.message);t===X&&(e!=null&&e.pendingConfirmation)&&(a=!0,r="Order placed successfully! However your transaction is pending for review. Please contact the business owner");const n=f("msgsndr_id").value;await si(i,n,e,d);const g=f("provider");g.value=t===R?"pp":"cc",await oi({sessionId:i.sessionId,sessionFingerprint:e.sessionFingerprint},s);const c=sessionStorage.getItem("redirect");if(li(s),c){sessionStorage.removeItem("redirect"),window.location.href=c;return}return{paymentResponseData:e,authorizeOrderPendingConfirmation:a,authorizeOrderAlertMsg:r}},oi=(i,e)=>{i&&i.sessionId&&(p({sessionId:i.sessionId||null,locationId:e}),i.sessionFingerprint&&Q(e,i.sessionFingerprint))},ki=(i,e,t)=>{var s;return{facilitatorAccessToken:i.facilitatorAccessToken,orderId:(s=e==null?void 0:e.order)==null?void 0:s._id,paypalOrderId:i.orderID,altId:t,altType:"location",attribution:{eventData:B(),sessionId:V(t),sessionFingerprint:Z(t)}}},Fi=i=>{var t;(!(i.keyCode>=48&&i.keyCode<=57||i.keyCode>=96&&i.keyCode<=105)||!/^\d{0,2}$/.test((t=i.target)==null?void 0:t.value))&&i.keyCode!==8&&i.preventDefault()},li=i=>{const e=ri();return sessionStorage.setItem(`couponSessionId_${i}`,e),e};export{li as a,Pi as b,ti as c,ki as d,bi as e,_i as f,vi as g,Si as h,hi as i,Fi as k,wi as s};
